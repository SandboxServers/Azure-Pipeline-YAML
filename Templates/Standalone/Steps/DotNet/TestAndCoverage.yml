parameters:
  testProjectPath: ''
  buildConfiguration: 'Release'
  collectCoverage: true
  resultsDirectory: '$(Agent.TempDirectory)/testresults'
  testRunTitle: ''
steps:
- ${{ if ne(parameters.testProjectPath, '') }}:
  - pwsh: |
      $path = "${{ parameters.resultsDirectory }}"
      if (Test-Path $path) {
        Remove-Item -Recurse -Force $path
      }
      New-Item -ItemType Directory -Path $path | Out-Null
    displayName: 'Clean test results directory'
  - ${{ if eq(parameters.collectCoverage, true) }}:
    - pwsh: |
        $settingsPath = "$(Agent.TempDirectory)/coverlet.runsettings"
        @'
<?xml version="1.0" encoding="utf-8"?>
<RunSettings>
  <DataCollectionRunSettings>
    <DataCollectors>
      <DataCollector friendlyName="XPlat Code Coverage">
        <Configuration>
          <Format>cobertura</Format>
          <Exclude>[Dhadgar.*]Microsoft.AspNetCore.OpenApi.Generated*</Exclude>
          <ExcludeByFile>**/Migrations/*.cs;**/*.g.cs;**/*.g.i.cs;**/*.Designer.cs;**/*.Generated.cs;**/*.AssemblyInfo.cs;**/.NETCoreApp,Version=*/.NETCoreApp,Version*.AssemblyAttributes.cs</ExcludeByFile>
          <ExcludeByAttribute>CompilerGeneratedAttribute,GeneratedCodeAttribute</ExcludeByAttribute>
          <IncludeTestAssembly>false</IncludeTestAssembly>
          <UseSourceLink>true</UseSourceLink>
        </Configuration>
      </DataCollector>
    </DataCollectors>
  </DataCollectionRunSettings>
</RunSettings>
'@ | Set-Content -Path $settingsPath -Encoding UTF8
        Write-Host "Using coverlet settings at $settingsPath"
      displayName: 'Write coverlet runsettings'
    - task: DotNetCoreCLI@2
      displayName: 'dotnet test'
      inputs:
        command: 'test'
        projects: ${{ parameters.testProjectPath }}
        publishTestResults: false
        arguments: >
          -c ${{ parameters.buildConfiguration }}
          --logger "trx"
          --results-directory "${{ parameters.resultsDirectory }}"
          --collect "XPlat Code Coverage"
          --settings "$(Agent.TempDirectory)/coverlet.runsettings"
  - ${{ if ne(parameters.collectCoverage, true) }}:
    - task: DotNetCoreCLI@2
      displayName: 'dotnet test'
      inputs:
        command: 'test'
        projects: ${{ parameters.testProjectPath }}
        publishTestResults: false
        arguments: >
          -c ${{ parameters.buildConfiguration }}
          --logger "trx"
          --results-directory "${{ parameters.resultsDirectory }}"
- task: PublishTestResults@2
  displayName: 'Publish test results'
  condition: and(succeededOrFailed(), ne('${{ parameters.testProjectPath }}', ''))
  inputs:
    testResultsFormat: VSTest
    testResultsFiles: '${{ parameters.resultsDirectory }}/**/*.trx'
    mergeTestResults: true
    failTaskOnFailedTests: true
    testRunTitle: ${{ parameters.testRunTitle }}
