parameters:
  testProjectPath: ''
  buildConfiguration: 'Release'
  collectCoverage: true
  resultsDirectory: '$(Agent.TempDirectory)/testresults'
  testRunTitle: ''
steps:
- ${{ if ne(parameters.testProjectPath, '') }}:
  - pwsh: |
      $path = "${{ parameters.resultsDirectory }}"
      if (Test-Path $path) {
        Remove-Item -Recurse -Force $path
      }
      New-Item -ItemType Directory -Path $path | Out-Null
    displayName: 'Clean test results directory'
  - ${{ if eq(parameters.collectCoverage, true) }}:
    - task: DotNetCoreCLI@2
      displayName: 'dotnet test'
      inputs:
        command: 'test'
        projects: ${{ parameters.testProjectPath }}
        publishTestResults: false
        arguments: >
          -c ${{ parameters.buildConfiguration }}
          --logger "trx"
          --results-directory "${{ parameters.resultsDirectory }}"
          --collect "XPlat Code Coverage"
  - ${{ if ne(parameters.collectCoverage, true) }}:
    - task: DotNetCoreCLI@2
      displayName: 'dotnet test'
      inputs:
        command: 'test'
        projects: ${{ parameters.testProjectPath }}
        publishTestResults: false
        arguments: >
          -c ${{ parameters.buildConfiguration }}
          --logger "trx"
          --results-directory "${{ parameters.resultsDirectory }}"
- task: PublishTestResults@2
  displayName: 'Publish test results'
  condition: and(succeededOrFailed(), ne('${{ parameters.testProjectPath }}', ''))
  inputs:
    testResultsFormat: VSTest
    testResultsFiles: '${{ parameters.resultsDirectory }}/**/*.trx'
    mergeTestResults: true
    failTaskOnFailedTests: true
    testRunTitle: ${{ parameters.testRunTitle }}
