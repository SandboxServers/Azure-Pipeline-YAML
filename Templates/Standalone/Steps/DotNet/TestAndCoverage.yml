parameters:
  testProjectPath: ''
  buildConfiguration: 'Release'
  collectCoverage: true
  resultsDirectory: '$(Agent.TempDirectory)/testresults'
  testRunTitle: ''
steps:
- ${{ if ne(parameters.testProjectPath, '') }}:
  - pwsh: |
      $path = "${{ parameters.resultsDirectory }}"
      if (Test-Path $path) {
        Remove-Item -Recurse -Force $path
      }
      New-Item -ItemType Directory -Path $path | Out-Null
    displayName: 'Clean test results directory'
  - ${{ if eq(parameters.collectCoverage, true) }}:
    - pwsh: |
        $settingsPath = "$(Agent.TempDirectory)/coverlet.runsettings"
        $xml = '<?xml version="1.0" encoding="utf-8"?>'
        $xml += '<RunSettings>'
        $xml += '<DataCollectionRunSettings>'
        $xml += '<DataCollectors>'
        $xml += '<DataCollector friendlyName="XPlat Code Coverage">'
        $xml += '<Configuration>'
        $xml += '<Format>cobertura</Format>'
        $xml += '<Exclude>[Dhadgar.*]Microsoft.AspNetCore.OpenApi.Generated*</Exclude>'
        $xml += '<ExcludeByFile>**/Migrations/*.cs;**/*DbContextFactory.cs;**/OpenApi/*.cs;**/obj/**/*.cs;**/*.g.cs;**/*.g.i.cs;**/*.Designer.cs;**/*.Generated.cs;**/*.AssemblyInfo.cs;**/.NETCoreApp,Version=*/.NETCoreApp,Version*.AssemblyAttributes.cs</ExcludeByFile>'
        $xml += '<ExcludeByAttribute>ExcludeFromCodeCoverage,CompilerGeneratedAttribute,GeneratedCodeAttribute</ExcludeByAttribute>'
        $xml += '<IncludeTestAssembly>false</IncludeTestAssembly>'
        $xml += '<UseSourceLink>true</UseSourceLink>'
        $xml += '</Configuration>'
        $xml += '</DataCollector>'
        $xml += '</DataCollectors>'
        $xml += '</DataCollectionRunSettings>'
        $xml += '</RunSettings>'
        $xml | Set-Content -Path $settingsPath -Encoding UTF8
        Write-Host "Using coverlet settings at $settingsPath"
      displayName: 'Write coverlet runsettings'
    - task: DotNetCoreCLI@2
      displayName: 'dotnet test'
      inputs:
        command: 'test'
        projects: ${{ parameters.testProjectPath }}
        publishTestResults: false
        arguments: >
          -c ${{ parameters.buildConfiguration }}
          --logger "trx"
          --results-directory "${{ parameters.resultsDirectory }}"
          --collect "XPlat Code Coverage"
          --settings "$(Agent.TempDirectory)/coverlet.runsettings"
          -- /m
  - ${{ if ne(parameters.collectCoverage, true) }}:
    - task: DotNetCoreCLI@2
      displayName: 'dotnet test'
      inputs:
        command: 'test'
        projects: ${{ parameters.testProjectPath }}
        publishTestResults: false
        arguments: >
          -c ${{ parameters.buildConfiguration }}
          --logger "trx"
          --results-directory "${{ parameters.resultsDirectory }}"
          -- /m
- task: PublishTestResults@2
  displayName: 'Publish test results'
  condition: and(succeededOrFailed(), ne('${{ parameters.testProjectPath }}', ''))
  inputs:
    testResultsFormat: VSTest
    testResultsFiles: '${{ parameters.resultsDirectory }}/**/*.trx'
    mergeTestResults: true
    failTaskOnFailedTests: true
    testRunTitle: ${{ parameters.testRunTitle }}
