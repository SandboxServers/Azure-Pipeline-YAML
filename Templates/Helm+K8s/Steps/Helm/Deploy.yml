parameters:
  chartName: ''
  releaseName: ''
  namespace: ''
  valuesFile: ''
  chartVersion: ''
  helmRegistry: ''
  upgrade: true
  timeout: '10m'
  testTimeout: '5m'

steps:
- bash: |
    set -e  # Exit on error

    # Validate chart version is provided
    if [ -z "${{ parameters.chartVersion }}" ]; then
      echo "❌ Error: chartVersion is required"
      exit 1
    fi

    # Validate namespace is provided
    if [ -z "${{ parameters.namespace }}" ]; then
      echo "❌ Error: namespace is required"
      exit 1
    fi

    echo "=== Deployment Configuration ==="
    echo "Chart: ${{ parameters.helmRegistry }}/${{ parameters.chartName }}"
    echo "Version: ${{ parameters.chartVersion }}"
    echo "Release: ${{ parameters.releaseName }}"
    echo "Namespace: ${{ parameters.namespace }}"
    echo "Timeout: ${{ parameters.timeout }}"
    echo "================================"
  displayName: 'Validate deployment parameters'

- ${{ if eq(parameters['upgrade'], true) }}:
  - bash: |
      set -e  # Exit on error

      # Check if values file exists (if specified)
      if [ -n "${{ parameters.valuesFile }}" ] && [ ! -f "${{ parameters.valuesFile }}" ]; then
        echo "⚠️ Warning: Values file not found: ${{ parameters.valuesFile }}"
        echo "Continuing without values file..."
        VALUES_ARGS=""
      else
        VALUES_ARGS="--values ${{ parameters.valuesFile }}"
      fi

      # Perform Helm upgrade with retry logic
      MAX_RETRIES=2
      RETRY_COUNT=0

      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
        if helm upgrade ${{ parameters.releaseName }} \
          ${{ parameters.helmRegistry }}/${{ parameters.chartName }} \
          --version ${{ parameters.chartVersion }} \
          --namespace ${{ parameters.namespace }} \
          $VALUES_ARGS \
          --install \
          --create-namespace \
          --wait \
          --timeout ${{ parameters.timeout }} \
          --atomic \
          --debug; then
          echo "✅ Successfully deployed ${{ parameters.chartName }}:${{ parameters.chartVersion }} to ${{ parameters.namespace }}"
          exit 0
        else
          RETRY_COUNT=$((RETRY_COUNT + 1))
          if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            echo "⚠️ Deployment failed (attempt $RETRY_COUNT/$MAX_RETRIES), retrying in 10 seconds..."
            sleep 10
          fi
        fi
      done

      echo "❌ Failed to deploy chart after $MAX_RETRIES attempts"
      exit 1
    displayName: 'Deploy Helm chart'
    env:
      HELM_EXPERIMENTAL_OCI: 1

  - bash: |
      set -e  # Exit on error

      echo "=== Running Helm Tests ==="

      if helm test ${{ parameters.releaseName }} \
        --namespace ${{ parameters.namespace }} \
        --timeout ${{ parameters.testTimeout }} \
        --logs; then
        echo "✅ Helm tests passed"
      else
        echo "⚠️ Helm tests failed (but deployment may still be functional)"
        # Don't fail the pipeline if tests fail
        exit 0
      fi
    displayName: 'Test Helm deployment'
    condition: succeededOrFailed()
    env:
      HELM_EXPERIMENTAL_OCI: 1
  ${{ else }}:
  - bash: |
      helm test ${{ parameters.releaseName }} \
        --namespace ${{ parameters.namespace }} \
        --timeout ${{ parameters.testTimeout }}
    displayName: 'Test Helm deployment'
    condition: succeededOrFailed()
    env:
      HELM_EXPERIMENTAL_OCI: 1
