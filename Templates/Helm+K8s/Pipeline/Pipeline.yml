parameters:
- name: Environments
  displayName: Environments
  type: object
  default:
  - env: dev
  - env: prod
- name: ChartName
  displayName: Chart Name
  type: string
  default: meridian-console
- name: ChartPath
  displayName: Chart Path
  type: string
  default: deploy/kubernetes/helm/meridian-console
- name: ACRName
  displayName: ACR Name
  type: string
  default: meridianconsoleacr
- name: HelmVersion
  displayName: Helm Version
  type: string
  default: 3.13.0
- name: VariableLocation
  displayName: Variable Location
  type: string
  default: /pipeline/variables
- name: ACRServiceConnection
  displayName: ACR Service Connection
  type: string
  default: ''
- name: DeployTimeout
  displayName: Deploy Timeout
  type: string
  default: '10m'
- name: TestTimeout
  displayName: Test Timeout
  type: string
  default: '5m'

stages:
- template: ../stages/build.yml@YAML
  parameters:
    ChartName: ${{ parameters.ChartName }}
    ChartPath: ${{ parameters.ChartPath }}
    ACRName: ${{ parameters.ACRName }}
    HelmVersion: ${{ parameters.HelmVersion }}
    VariableLocation: ${{ parameters.VariableLocation }}
    ACRServiceConnection: ${{ parameters.ACRServiceConnection }}
- ${{ if ne(variables['Build.Reason'], 'PullRequest') }}:
  - ${{ each environment in parameters.environments }}:
    - template: ../stages/deploy.yml@YAML
      parameters:
        ChartName: ${{ parameters.ChartName }}
        Environment: ${{ environment.env }}
        ValuesFile: ${{ parameters.VariableLocation }}/${{ environment.env }}.yml
        ChartVersion: $[ stageDependencies.Build.publish.outputs['publish_helm.CHART_VERSION'] ]
        HelmRegistry: $(helmRegistry)
        Namespace: ${{ environment.namespace }}
        ReleaseName: ${{ environment.releaseName }}
        DeployTimeout: ${{ parameters.DeployTimeout }}
        TestTimeout: ${{ parameters.TestTimeout }}
