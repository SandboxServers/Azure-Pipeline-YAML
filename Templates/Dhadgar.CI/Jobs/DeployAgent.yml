# Deploy Agent Job
# Downloads Agent artifacts from Package stage and publishes to GitHub Releases
#
# This job expects artifacts from PackageAgent job in Package stage

parameters:
  serviceName: ''
  environment: 'dev'
  projectPath: ''  # Not used for building anymore, kept for compatibility
  runtimes: 'win-x64;linux-x64'  # Not used for building anymore
  publishToGitHub: true
  isPreRelease: true

jobs:
  - deployment: DeployAgent_${{ replace(parameters.serviceName, '.', '_') }}
    displayName: 'Deploy (Agent): ${{ parameters.serviceName }}'
    environment: 'meridian-${{ parameters.environment }}'
    pool:
      name: 'Sandbox Servers Agents'
    download: none
    strategy:
      runOnce:
        deploy:
          steps:
            # Download Agent artifacts from Package stage
            - task: DownloadPipelineArtifact@2
              displayName: 'Download Agent artifacts'
              inputs:
                buildType: 'current'
                artifactName: agent-${{ replace(parameters.serviceName, '.', '_') }}
                targetPath: '$(Pipeline.Workspace)/agent-artifacts'

            - ${{ if eq(parameters.publishToGitHub, true) }}:
              - task: GitHubRelease@1
                displayName: 'Create GitHub Release'
                condition: succeeded()
                inputs:
                  gitHubConnection: 'github.com_SandboxServers'
                  repositoryName: '$(Build.Repository.Name)'
                  action: 'create'
                  target: '$(Build.SourceVersion)'
                  tagSource: 'userSpecifiedTag'
                  tag: "agent-${{ replace(parameters.serviceName, 'Dhadgar.', '') }}-v$(Build.BuildNumber)"
                  title: "Agent Release: ${{ parameters.serviceName }} v$(Build.BuildNumber)"
                  isPreRelease: ${{ parameters.isPreRelease }}
                  releaseNotesSource: 'inline'
                  releaseNotesInline: |
                    ## Agent Release v$(Build.BuildNumber)

                    **Agent:** ${{ parameters.serviceName }}
                    **Environment:** ${{ parameters.environment }}
                    **Build:** $(Build.BuildNumber)

                    ### Downloads
                    - Windows (x64): `${{ replace(parameters.serviceName, 'Dhadgar.', '') }}-win-x64.zip`
                    - Linux (x64): `${{ replace(parameters.serviceName, 'Dhadgar.', '') }}-linux-x64.tar.gz`
                  assets: '$(Pipeline.Workspace)/agent-artifacts/*'
                  addChangeLog: true
