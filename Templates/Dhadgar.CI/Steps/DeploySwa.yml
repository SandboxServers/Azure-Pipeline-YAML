parameters:
  apiToken: ''
  appLocation: '.'
  outputLocation: '_swa_publish/wwwroot'
  appBuildCommand: ''
  nodeVersion: '20.x'
steps:
# Build the app manually to avoid Oryx's .NET 10.0 detection issue
# Oryx detects csproj files and fails on unsupported .NET versions before
# running custom build commands, so we build first then skip Oryx's build
- ${{ if ne(parameters.appBuildCommand, '') }}:
  - task: NodeTool@0
    displayName: 'Install Node.js'
    inputs:
      versionSpec: ${{ parameters.nodeVersion }}

  - task: Bash@3
    displayName: 'Build app (npm)'
    inputs:
      targetType: inline
      workingDirectory: ${{ parameters.appLocation }}
      script: |
        set -e
        echo "Building in $(pwd)"
        echo "Node version: $(node --version)"
        echo "npm version: $(npm --version)"
        ${{ parameters.appBuildCommand }}
        echo "Build complete. Checking output directory..."
        ls -la ${{ parameters.outputLocation }}

- task: AzureStaticWebApp@0
  displayName: 'Deploy to Azure Static Web Apps'
  inputs:
    azure_static_web_apps_api_token: ${{ parameters.apiToken }}
    # When skip_app_build is true, app_location must point directly to the built files
    # SWA ignores output_location when skipping build
    ${{ if ne(parameters.appBuildCommand, '') }}:
      app_location: ${{ parameters.appLocation }}/${{ parameters.outputLocation }}
      skip_app_build: true
    ${{ else }}:
      app_location: ${{ parameters.appLocation }}
      output_location: ${{ parameters.outputLocation }}
