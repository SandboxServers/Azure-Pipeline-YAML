parameters:
  apiToken: ''
  appLocation: '.'
  outputLocation: '_swa_publish/wwwroot'
  appBuildCommand: ''
  nodeVersion: '20.x'
steps:
# Build the app manually to avoid Oryx's .NET 10.0 detection issue
# Oryx detects csproj files and fails on unsupported .NET versions before
# running custom build commands, so we build first then skip Oryx's build
- ${{ if ne(parameters.appBuildCommand, '') }}:
  - task: NodeTool@0
    displayName: 'Install Node.js'
    inputs:
      versionSpec: ${{ parameters.nodeVersion }}

  - task: Bash@3
    displayName: 'Build app (npm)'
    inputs:
      targetType: inline
      workingDirectory: ${{ parameters.appLocation }}
      script: |
        set -e
        echo "Building in $(pwd)"
        echo "Node version: $(node --version)"
        echo "npm version: $(npm --version)"
        ${{ parameters.appBuildCommand }}
        echo "Build complete. Checking output directory..."
        ls -la ${{ parameters.outputLocation }} || echo "Output directory not found!"

- task: AzureStaticWebApp@0
  displayName: 'Deploy to Azure Static Web Apps'
  inputs:
    azure_static_web_apps_api_token: ${{ parameters.apiToken }}
    app_location: ${{ parameters.appLocation }}
    output_location: ${{ parameters.outputLocation }}
    # Skip Oryx build entirely - we already built the app above
    # This avoids the .NET 10.0 unsupported version error from Oryx
    skip_app_build: true
