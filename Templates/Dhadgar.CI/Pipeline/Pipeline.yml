parameters:
- name: services
  type: object
  default: []
- name: servicesCsvNormalized
  type: string
  default: ',,'
- name: buildConfiguration
  type: string
  default: 'Release'
- name: dotnetSdkVersion
  type: string
  default: '10.0.x'
- name: includePreview
  type: boolean
  default: true
- name: runTests
  type: boolean
  default: true
- name: collectCoverage
  type: boolean
  default: true
- name: deploy
  type: boolean
  default: true
# Local dev compose deploys (agent demand selector for localdev stage)
- name: localAgentDemand
  type: string
  default: ''
# Helm publish/deploy settings
- name: publishHelmChart
  type: boolean
  default: true
- name: publishComposeAssets
  type: boolean
  default: true
- name: composeAssetPath
  type: string
  default: 'deploy/compose'
- name: composeAssetArtifactName
  type: string
  default: 'compose-assets'
- name: helmChartPath
  type: string
  default: 'deploy/kubernetes/helm/meridian-console'
- name: helmChartRoot
  type: string
  default: 'deploy/kubernetes/helm'
- name: helmChartName
  type: string
  default: 'meridian-console'
- name: helmVersion
  type: string
  default: '3.13.0'
- name: helmReleaseName
  type: string
  default: 'meridian'
- name: imageTag
  type: string
  default: '$(Build.BuildId)'
# Infrastructure provisioning parameters
- name: provisionInfrastructure
  type: boolean
  default: false
- name: provisionDns
  type: boolean
  default: false
- name: environment
  type: string
  default: 'localdev'
  values:
    - localdev
    - dev
    - qa
    - staging
    - prod
- name: azureServiceConnection
  type: string
  default: 'meridian-rg-sc-2'
- name: acrServiceConnection
  type: string
  default: 'meridianconsoleacr'
- name: acrLoginServer
  type: string
  default: 'meridianconsoleacr-etdvg4cthscffqdf.azurecr.io'
- name: acrName
  type: string
  default: 'meridianconsoleacr'
- name: cloudflareApiToken
  type: string
  default: ''
- name: tenantId
  type: string
  default: ''
- name: kubernetesServiceConnection
  type: string
  default: 'meridiank8s'

stages:
# Build & Test Stage
- template: ../Stages/Build.yml
  parameters:
    services: ${{ parameters.services }}
    servicesCsvNormalized: ${{ parameters.servicesCsvNormalized }}
    buildConfiguration: ${{ parameters.buildConfiguration }}
    dotnetSdkVersion: ${{ parameters.dotnetSdkVersion }}
    includePreview: ${{ parameters.includePreview }}
    runTests: ${{ parameters.runTests }}
    collectCoverage: ${{ parameters.collectCoverage }}

# Package Stage (Container builds + binary packaging)
# Runs after Build, builds Docker images and packages CLI/Agent binaries
- template: ../Stages/Package.yml
  parameters:
    services: ${{ parameters.services }}
    servicesCsvNormalized: ${{ parameters.servicesCsvNormalized }}
    buildConfiguration: ${{ parameters.buildConfiguration }}
    publishHelmChart: ${{ parameters.publishHelmChart }}
    publishComposeAssets: ${{ parameters.publishComposeAssets }}
    composeAssetPath: ${{ parameters.composeAssetPath }}
    composeAssetArtifactName: ${{ parameters.composeAssetArtifactName }}
    helmChartPath: ${{ parameters.helmChartPath }}
    helmChartRoot: ${{ parameters.helmChartRoot }}
    helmChartName: ${{ parameters.helmChartName }}
    helmVersion: ${{ parameters.helmVersion }}
    acrName: ${{ parameters.acrName }}
    acrServiceConnection: ${{ parameters.acrServiceConnection }}
    acrLoginServer: ${{ parameters.acrLoginServer }}
    azureServiceConnection: ${{ parameters.azureServiceConnection }}

# Infrastructure Provisioning Stage (optional)
- ${{ if eq(parameters.provisionInfrastructure, true) }}:
  - template: ../Stages/Infrastructure.yml
    parameters:
      environment: ${{ parameters.environment }}
      azureServiceConnection: ${{ parameters.azureServiceConnection }}
      cloudflareApiToken: ${{ parameters.cloudflareApiToken }}
      provisionAzure: ${{ parameters.provisionInfrastructure }}
      provisionDns: ${{ parameters.provisionDns }}
      tenantId: ${{ parameters.tenantId }}

# Release Stage (SWA deployments)
- template: ../Stages/Release.yml
  parameters:
    services: ${{ parameters.services }}
    servicesCsvNormalized: ${{ parameters.servicesCsvNormalized }}
    buildConfiguration: ${{ parameters.buildConfiguration }}
    deploy: ${{ parameters.deploy }}

# Deploy Stage (Compose, CLI, Agent deployments)
# Downloads artifacts from Package stage and deploys to target environments
- ${{ if eq(parameters.deploy, true) }}:
  - template: ../Stages/Deploy.yml
    parameters:
      services: ${{ parameters.services }}
      servicesCsvNormalized: ${{ parameters.servicesCsvNormalized }}
      environment: ${{ parameters.environment }}
      localAgentDemand: ${{ parameters.localAgentDemand }}
      acrServiceConnection: ${{ parameters.acrServiceConnection }}
      acrLoginServer: ${{ parameters.acrLoginServer }}
      deploy: ${{ parameters.deploy }}

# Kubernetes Deploy Stage (dev/qa/prod)
- ${{ if and(eq(parameters.deploy, true), ne(parameters.environment, 'localdev')) }}:
  - template: ../Stages/DeployKubernetes.yml
    parameters:
      environment: ${{ parameters.environment }}
      namespace: ${{ parameters.environment }}
      kubernetesServiceConnection: ${{ parameters.kubernetesServiceConnection }}
      azureServiceConnection: ${{ parameters.azureServiceConnection }}
      acrName: ${{ parameters.acrName }}
      acrLoginServer: ${{ parameters.acrLoginServer }}
      helmChartName: ${{ parameters.helmChartName }}
      helmVersion: ${{ parameters.helmVersion }}
      releaseName: ${{ parameters.helmReleaseName }}
      imageTag: ${{ parameters.imageTag }}
